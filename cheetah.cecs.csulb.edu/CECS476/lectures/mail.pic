\def\chapternumber{Mail -- 1 May 2012}
\input slides.tex
\centerline{\bbf E-Mail}

Mail User Agent:
\break
edit messages
\break
when you send it hands them to the MSA
\break
the MSA then hands it to the MTA for transmission

read messages
\break
they must be in your mail spool file 
\break
(placed there by the MTA)

Mail Submission Agent
\break
Receive mail from the MUA, hand it to the MTA.

Mail Transport Agent

Gets mail from a MSA or MTA and:
\break
1) places it in a local file (users mail spool)
\break
2) forwards it to another MTA (forwarded mail)
\break
(watch out for SPAM)

Simple Mail Transport Protocol (SMTP)-- 
\break
The protocol that defines how MTAs exchange mail
\break
You don't to be the same MTA, but both MTAs must use SMTP
Some MSA/MTA transfers are proprietary, but most use SMTP.
\newslide
\centerline{\bbf SMTP example}

Sending mail from {\ltt{}p.edu} to {\ltt{}q.edu}
\break
({\ltt{}s:}, {\ltt{}r:} added to id sender, receiver)
\break
Sender uses commands
\break
Receiver uses digital replys with comments

{\program
r: 220 q.edu
s: EHLO p.edu
r: 250 Hello p.edu
s: MAIL FROM:<bob@p.edu>
r: 250 Ok
s: RCPT TO:<sue@q.edu>
r: 250 OK
s: DATA
r: 354 end message with .
s: From:"My Bob" <bob@p.edu>
s: To:"Your Sue" <sue@q.edu>
s: ....
s: .
r: 250 OK
s: QUIT
r: 221 Bye bye
\endprogram}

No particular correspondence between
\break
``{\ltt{}To:}" and ``{\ltt{}RCPT TO:}"

\newslide
\centerline{\bbf Standart Mail Message Format}

{\ltt{}From:} -- newer MUAs, the sender

{\ltt{}To:}
the recipients. 
A comma separated list.

{\ltt{}cc:} more recipients

{\ltt{}Date:}
Original posting date

{\ltt{}Received:}
added by MTAs as they receive and forward messages
(useful in back tracing problem messages)

The message body may be restricted to a maximum of 80 characters per line
for backward compatibility with old systems.

Other than appending to the ``{\ltt{}Received:}" the MTA's often
do not modify the message format.
\break
However, they may be specifically instructed to rewrite things like
the from and to addresses.

\newslide
\centerline{\bbf Mail Storage Format}

mbox format:

All incoming mail for a user is placed in a single file.
\break
If using folders, each folder is an mbox format file.
Each message starts with a special from line (no colon)
so the MUAs can find the different messages.

\vt
maildir format:

There is a mail directory.
\break
Each message is stored in a separate file.
\break
Subdirectories are usually {\ltt{}new}, {\ltt{}cur}, {\ltt{}tmp}

\newslide

Several MUAs exist:
\break
elm, pine, mail, Thunderbird, Eudora...

Several MTAs exits:
\break
sendmail, smail, mmdf, Microsoft Exchange
\vf
Mail exchangers:
\break
A machine that receives mail for a set of machines,
\break
usually an entire Internet domain
\break
All mail coming into {\ltt{}cecs.csulb.edu} goes to
{\ltt{}charlotte.cecs.csulb.edu}

That machine forwards it to others on campus.

DNS has an MX record that gives the mail exchanger 

Side effect of using exchangers: if that machine is down,
\break
all mail halts.
\break
Solution: priority list of mail servers.
\break
Each MX record has a priority number attached

Aliases:
\break
{\ltt{}cecs-faculty}: an alias for about 30 names.
\break
{\ltt{}/etc/mail/aliases}
\break
{\ltt{}/etc/mail/aliases.db}
\newslide
\centerline{\bbf Configuring Sendmail}

{\ltt{}sendmail} is a smtp delivery program

Its behavior is governed by {\ltt{}/etc/mail/sendmail.cf}

This file contains regular expressions and replacement rules.

Rule lines begin with {\ltt{}R}

{\ltt{}R$* % $*      $1 @ $2}

{\ltt{}$*} match any thing
\break
{\ltt{}%} match a percent sign
\break
{\ltt{}$*} match any thing

{\ltt{}$1} what ever is matched by the first the first {\ltt{}$*}

{\ltt{}$2} what ever is matched by the second the first {\ltt{}$*}

{\ltt{}joe%cheetah} is matched and
\break
rewritten as: {\ltt{}joe@cheetah}

Some of those rules refer to databases ({\ltt{}.db} format)
\break
aliases -- mail aliases
\break
domaintable -- old domain name, new domain name
\break
mailertable -- overrides routing for particular domains
\break
virtusertable -- address, real address
\break
access -- can refuse mail from specific domains

\newslide
Rules are gathered into rule sets

{\cprogram
S97
R$*                     $: $>3 $1
R$*                     $@ $>0 $1
@endprogram}

These may be used as subroutines

{\ltt{}$>3} invokes ruleset 3 ({\ltt{}S3}) and uses the result.

macros replacements may be defined
\break
{\ltt{}DS yei.csulb.edu}
\break
The smart host macro {\ltt{}$S} is set to {\ltt{}yei}
\break
{\ltt{}D\char123{}Hi\char125 MulticharacterMacro}
\break
A macro with a multi-character name

Groups (classes) may be defined
\break
{\ltt{}CLroot volper sam}
\break
The {\ltt{}$=L} group has three members
\break
These are locally delivered even if all mail is forwarded to another machine.

Options may be listed
\break
{\ltt{}Odbackground}
\break
The delivery option is background

\newslide
Various mailer programs may be used
\break
{\ltt{}Msmtp P=[IPC]...}
\break
The program {\ltt{}P} is invoked, the one here is a special indicator
meaning make an IP Connection to another sendmail
\break
{\ltt{}R<@> $#local $: <>}
\break
send using the local mailer (defined by an {\ltt{}M} entry).
\break
Use the address found in the {\ltt{}<>}

\newslide
\centerline{\bbf Administration}

A: Use and adjust the databases. (Forwards, blocks)

B: Use m4 macros (IDA) to generate a {\ltt{}sendmail.cf}.
Administer by adjusting (and re-compiling) the macros
({\ltt{}.mc} files).
\break
{\ltt{}/usr/share/sendmail/cf}  (Ubuntu)
\break
{\ltt{}/usr/share/sendmail/cf/cf}  (Slackware)


C: Adjust the macros in {\ltt{}sendmail.cf}
\break
Most configuration adjustments can be made one of the {\ltt{}D} or {\ltt{}C}
entries.

D: Edit the rule sets. If you are trying to do something unusual you may
end up here.

E: Rewrite the {\ltt{}sendmail} source code.
\vt
Address test mode:
\break
You can test a config without actually using it,
\break
but it takes a little effort
\break
{\ltt{}sendmail -bt -Cmyfile.cf}
\break
{\ltt{}-bt} --- address test mode
\break
{\ltt{}-Cmyfile.cf} --- config file to be tested

Usually start with ruleset 3,0, but to test other things (like
reply address rewrites) you may want to start with another
ruleset.
\newslide
Daemon mode:  {\ltt{}-bd}
\break
Start the mail transport server
\break
and it is to run forever.

Services, inetd entry:

The services entry is there,
\break
Port 25 is the mail port (standard)

the inetd entry is commented out
\break
When another machine connects to port 25, start a mail server
\break
(only if the mail server is not running daemon mode)
\vt
Mail trick: configure sendmail to send only;
\break
only configure the mail exchanger to receive mail.

\newslide
\centerline{\bbf Local Mail Handling}

sendmail (and smail) hands local mail to a local
mailer program (whose name is specified in the cf file).
This local program (probably) places the mail in the spool.

{\ltt{}procmail}---a very flexible local mail program

Normal operation: drop the mail into the spool.

vacation/.forward--reads the .forward file, runs a
program that sends a message and logs the name of the user
to whom it was sent and saves the mail in the spool.
A user will only be sent the message once.

{\ltt{}.procmailrc}--full rules file for disposition.

Can: leave in spool, forward to an address, place in folders.
\newslide
File format:
\break
{\ltt{}:0} {\bit [flags]} {\bit [:[locallockfile]] } beginning of a recipe
\break
Regular expression to be match conditions (1 per line),
these lines start with a *
\break
dispositions/actions (if matched)

\vt
{\program
:0
* ^From.*volper
$HOME/mymaildir/ccs
\endprogram}

Any thing with a ``From ... volper" automatically goes to the
file {\ltt{}ccs}, does not show up in my inbox.

\vt
{\program
:0:
* ^Subject.*homework
homeworkmail
\endprogram}

Subject of homework goes to the file {\ltt{}homeworkmail},
that file is also used as a lockfile.

\vt
{\program
:0:otherlock
* 
! newaddress@newplace.com
\endprogram}

All ({\ltt{}*}) mail is Forwarded ({\ltt{}!}) to newaddress.
The file {\ltt{}otherlock} is used as a lock file 
\newslide
{\program
:0
* 
| $HOME/bin/mymailparseprogram
\endprogram}

All ({\ltt{}*}) mail is sent (piped) ({\ltt{}|}) to a program

Flags: 
\break
{\ltt{}B} apply the condition to the body
\break
{\ltt{}H} apply the condition to the header (default)

\vt
{\program
:0 B:
* BUY NOW
/dev/null
\endprogram}

Any mail whose body contains the phrase {\ltt{}BUY NOW} 
is discarded.


Beware: mail loops are easy to create.

\newslide
\centerline{\bbf Pop and Imap}

Support for remote MUAs.

Example: Windows/Thunderbird  access to Unix mail.

Post Office Protocol

{\ltt{}popd} --- running on Unix server
\break
Connect to {\ltt{}popd}
\break
User name and password are required
\break
{\ltt{}popd} provides access to Unix mail spool.
\break
Used by Eudora, Thunderbird, Outlook

Sending mail: connect to {\ltt{}sendmail} on
server (using SMTP).

IMAP: access remote mail with
\break
Internet Message Access Protocol
\break
newer than pop, does basically the same thing
\break
adds the ability to send mail

\vt
Enabling pop or imap on Slackware:
\break
uncomment the correct line(s) in {\ltt{}inetd.conf}

Ubuntu: these are bundled in the {\ltt{}dovecot} package

\newslide
\centerline{\bbf Mail Filters}

Several mail filters are available for sendmail and may be installed.


spamassassin: A Baysian filter. Teach the filter using examples
of spam and ham. You can configure it to label spam or drop spam.

mimedefang: a wrapper for antivirus filtering. Various antivirus
filters can be attached. Can be set to quarantine, delete infected
portions, or drop infected messages.

clamav: an antivirus filter. Make sure you keep the virus patterns up-to-date.

\newslide
\centerline{\bbf Configuring sendmail using mc}

Ubuntu:

{\ltt{}Makefile}: causes the make command to rebuild the {\ltt{}.cf}
files from the {\ltt{}.mc} configurations.

1) Edit {\ltt{}sendmail.mc} and/or {\ltt{}submit.mc}.

2)  {\ltt{}make; make install-cf}
\breadk
other cf's will be built (but not installed).

\vf

Slackware:

Configuration directory: {\ltt{}/usr/share/sendmail/cf/cf}
\break
contains {\ltt{}.mc} files for lots sites (as examples).

Pick one or make one (use {\ltt{}cp}), edit it (say {\ltt{}xx.mc})

Use the {\ltt{}Build} command to create the cf.
\break
{\ltt{}Build xx} creates {\ltt{}xx.cf} from {\ltt{}xx.mc}

Then use {\ltt{}cp} to copy it into the {\ltt{}/etc/sendmail}
directory, giving it the correct name
({\ltt{}sendmail.cf} or {\ltt{}submit.cf})

\newslide
\centerline{\bbf mc File Notes}

In general:

when adding a {\ltt{}FEATURE}
\break
add it at the end of the existing features

when adding a {\ltt{}MAILER}
\break
add it at the end of the existing mailers

and so forth.

In some cases order matters in the {\ltt{}.mc} file.

\vf
Warning: in the following slides
\break
I've had to split lines to fit the slides,
\break
some of the capabilities will not allow you to do that in the files.

\newslide
\centerline{\bbf sendmail.mc}

local mail only:
\break
You can modify so that mail is local only

{\cprogram
DAEMON_OPTIONS('Family=inet, Name=MTA,
  Addr=127.0.0.1')dnl
@endprogram}

Slackware uses the default from {\ltt{}config.mc} which lacks the restrictive
{\ltt{}Addr} entry.

\vt

procmail:
\break
You need the procmail feature and feature (there by default on Slackware,
not on Ubuntu).

{\cprogram
FEATURE(`local_procmail',`',
  `procmail -t -Y -a $h -d $u')dnl
MAILER(procmail)dnl
@endprogram}

\vt

mail filter:

{\cprogram
INPUT_MAIL_FILTER(`mimedefang',
  `S=unix:/var/spool/mimedefang/mimedfang.sock,
    F=T,T+S:5m;R:5m')dnl
@endprogram}

The filter name, the socket to talk to the filter on, parameters for using
the filter.
\break
You start the filter as a separate daemon.

\newslide
\centerline{\bbf sendmail.mc}

mail host:
\break
You can have your local mail handled by a mail hub.
All mail that is destined for the local machine goes to this
machine instead.
Useful if you have a central server for alot of machines and accounts.

{\cprogram
define(`MAIL_HUB',`mailserver.example.com')
@endprogram}

smart host:
\break
You may have your non-local mail handled by a mail exchanger.
All non-local mail is sent to this machine and relayed from there
to the destination machine.
(Note: the exchanger needs to have relaying enabled for the machines
that it expects to relay for.)
Useful if you are behind a firewall and only the mail exchanger has
permission to send mail to external machines.

{\cprogram
define(`SMART_HOST',`mailserver.example.com')
@endprogram}

masquerade:
\break
You may modify the return address so that mail appears to come from a
different place. Usually you modify this to your domain name or to
the name of your mail exchanger.

{\cprogram
MASQUERADE_AS(cecs.csulb.edu)
@endprogram}

\newslide
\centerline{\bbf Files}

Configuration files are located in {\ltt{}/etc/mail}
\break
Change the file, run ``make" to update the database ({\ltt{}.db}) file.

{\ltt{}local-host-names}:
\break
Your machine may be called as any one of these names so the mail server
recognizes them all as being the machine it is running on.

{\cprogram
localhost
charlotte.cecs.csulb.edu
cecs.csulb.edu
@endprogram}

{\ltt{}access}:
\break
Controls who can use your mailer for what.

{\cprogram
connect:192.168.1 RELAY
connect:net.cecs.csulb.edu RELAY
@endprogram}

You are willing to relay mail machines inside your private subnet.

\bye
