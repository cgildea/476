\def\chapternumber{News -- 23 April 2008}
\input slides.tex
\centerline{\bbf Network News}

Usenet: (not a network)
A set of over 1000 news groups that are transfered around the net.

Earliest groups (e.g., unix-wizards) were used by sysadms
to share patches.

Now hierarchically organized:
\break
{\ltt{}comp.os.linux.networking}
\break
{\ltt{}comp.os.linux.development.system}
\break
{\ltt{}comp.lang.ada}

News server: machine on which the news articles are stored
\break
News feed: machine from which the news server receives news

Flooding: you get a batch of articles from a one of your news feeds
and forward them to others.

Main csulb news feed: UCI
\break
We get most of the network news from UCI.
\break
News groups originating at CSULB are sent to UCI

Volume: Current daily volume is GBytes
\break
(hours of T1 link)
\break
(a week at 56K)
\newslide
NNTP (Network News Transfer Protocol): RFC 977
\break
News Message format: RFC 1036

Getting a news feed:
\break
People protocol: Negotiate with other sysadm
\break
Software protocol:
please feed the following newsgroups.

Newsgroup transfer: 
\break
all articles are given a unique ID by originator
\break
{\ltt{}<22389@heart.engr.csulb.edu>}

articles have a path attached
\break
(helps avoid feed-back loops)
\break
Note: most news readers don't display the full header.
\break
{\ltt{}Path: csulb.edu!hub.csu.edu!cs.utexas.edu}
\break
Last name on path is the originator.
\break
Before feeding, check if site to be fed is in path
\break
(e.g., don't send to {\ltt{}hub} or {\ltt{}utexas})

Articles are (locally) numbered by receiver in order of receipt
\break
{\ltt{}Article 39883 of comp.lang.ada:}
\break
numbering is ``per newsgroup"
\break
Note: same article may have different numbers on different servers
because order of receipt varies.

\newslide
\centerline{Network News Overview}

{\ltt{}innd} is responsible for the transport of news groups.

Usually there is a user called {\ltt{}news}
\break
and group called {\ltt{}news} (safer than root)

News owns spool directory ({\ltt{}/var/spool/news})
\break
active/history directory ({\ltt{}/var/lib/news})
\break
executable directory ({\ltt{}/usr/lib/news})
\break
and config directory ({\ltt{}/etc/news})

News articles are stored in files organized by news group

Article {\ltt{}2345} from {\ltt{}comp.lang.ada}
\break
In file:
{\ltt{}/var/spool/news/articles/comp/lang/ada/2345}

News transfer: Request all articles that have
arrived since a specified time.
\break
Usually the time of the last transfer.
\break
Some may be duplicates to be dumped,
\break
but most will be new.

nntp ({\ltt{}innd}) uses TCP Port 119.
\newslide
\centerline{{\bbf INN overview}
\centerline{({\ltt{}innd})}

{\ltt{}/etc/news} --- Configuration and control files
\break
{\ltt{}/var/lib/news/run} --- process and pipe information

{\ltt{}/usr/lib/news/bin} --- {\ltt{}innd}, {\ltt{}rc.news},
setup, configuration and control programs

{\ltt{}/usr/doc/inn-2.4.2} --- documentation
\break
also the online manual

{\ltt{}/var/spool/news} where the news articles will live
\break
Subdirectories of {\ltt{}/var/spool/news}
\break
{\ltt{}outgoing} --- things related to sending to other sites
\break
{\ltt{}incoming} --- temporary repository before sorting to newsgroup
directories.
\break
{\ltt{}articles} --- where the news articles live,
subdirectories hold the news articles
\break
{\ltt{}overview} --- summaries

{\ltt{}/var/log/news} log/debugging information
\break
See also the following in {\ltt{}/var/log} for news related
messages and error reports:
\break
{\ltt{}debug}, {\ltt{}syslog}, {\ltt{}messages}.

\newslide
\centerline{\bbf INN Configuration}

password: {\ltt{}news:x:9:13:/usr/lib/news:/bin/csh}
\break
This is the account that is used for news.
\break
Release issue: make sure news has a shell

group: {\ltt{}news::13:news}
\break
Group 13, actually the second {\ltt{}news} is redundant

{\ltt{}/etc/mail/aliases}:
\break
{\ltt{}  news: root}
\break
{\ltt{}  usenet: root}
\break
Some programs send mail to news or usenet.
\break
These are redirected to root
\break
{\ltt{}newaliases}: run to install aliases

Add a crontab entry for {\ltt{}news} (not for your homework!!!)

{\ltt{}nntpsend} -- every 15 minutes send news out.
\break
{\ltt{}news.daily} -- once a day expire news and do other maintenance.
\break
{\ltt{}rnews} -- once an hour unbatch anything sitting in the in spool.
This happens only if something is broke or seriously clogged when
the batch arrives.

For homework, run {\ltt{}nntpsend} by hand (as {\ltt{}news}) to
push out the news in your spool.

\newslide
In {\ltt{}/var/lib/news} create the following files need to exist
(news.news 644) (use {\ltt{}makehistory} if they don't)

{\ltt{}history}   -- database for history
\break
{\ltt{}history.dir}
\break
{\ltt{}history.pag}

add to {\ltt{}rc.local} -- (not for your homework!!!)
\break
{\ltt{}/usr/lib/news/bin/rc.news}
\break
A scripts that does a setup check, rebuilds the history database,
and starts {\ltt{}innd}
\break
Recommendation: always start news with this command.
\break
Our system: {\ltt{}/etc/rc.d/rc.news} is a link to this file.

\newslide
\centerline{\bbf INN Control Files}

{\ltt{}/etc/nntpserver}: gives the name of the news server for
your machine.
\break
{\ltt{}/etc/organization} a name you choose

In {\ltt{}/var/lib/news}:

{\ltt{}active} -- list of newsgroups we receive.
\break
one line per group, list each group only once
\break
{\ltt{}name  himark  lomark flags}
\break
{\ltt{}comp.linux 25345 00001 y}

himark: we have received articles up through this.

lowmark: this is the lowest article number (cnews--absolute)
(innd--that hasn't expired).

Note: active numbers 0000000 0000001 should be used for a ``new" news group.

flags:
\break
{\ltt{}y} --  local posting allowed
\break
{\ltt{}x} -- no posting allowed
\break
{\ltt{}n} -- no local posting allowed
\break
{\ltt{}m} -- moderated
\break
{\ltt{}j} -- feed through, not kept

\vfill
{\ltt{}active.times} -- update times for each of the active news groups
\newslide
In {\ltt{}/etc/news}:

{\ltt{}incoming.conf} -- sites that are allowed to feed us.

{\program
peer lab89.net.cecs.csulb.edu {
  hostname: lab89.net.cecs.csulb.edu
}
\endprogram}

Name of the feed and name of the machine (keep both the same
for simplicity)

{\ltt{}readers.conf} -- says whose news readers can use us

{\program
auth "localhost" {
  hosts: "jaguar.net.cecs.csulb.edu,localhost,127.0.0.1,stdin"
  default: <localhost>
}
access "localhost" {
  users: *
  newsgroups: *
}
\endprogram}

If the reader doesn't match at least one {\ltt{}auth} record
access is denied.
\break
An {\ltt{}auth} record named localhost defines a group of 
users {\ltt{}<localhost>}, this group may appear in an {\ltt{}access}
record.
\break
An access record named localhost grants access to all news groups to
all users. The user group is unused.

\newslide
{\ltt{}inn.conf} -- Information about our site, like our hostname.

{\ltt{}nntpsend.ctl} -- controls sites 
to which we transfer news and
the conditions/limitations used when we do the transfer

{\ltt{}expire.ctl} -- instructions for when to delete old news
\break
{\ltt{}innfeed.conf} -- timing and batching information
\break
{\ltt{}passwd.nntp} -- if newsfeeds use passwords

{\ltt{}newsfeeds} -- distribution of incoming news to other sites
\break
(who we feed)

Four basic types of feeds:

log: the article will be mentioned in the news log

file: one line about the article will be written to an
outgoing spool file. (The article will be sent with the next
spool batch, at which point the file will be emptied.)

program: for each article a program is invoked (forked).
The article will be the standard input (stdin) for that program.

channel: a program is started. For each article a line is sent
to the program and the article becomes the stdin for the program.

\newslide
{\ltt{}newsfeeds}

{\program
ME:*,!alt.*,alt.local.*::
ai.uci.edu:comp.*,!comp.linux.*:Tf,Wnm:ai.uci.edu
x.y.csulb.edu/q.csulb.edu:*/!gnu.*:F/var/spool:
\endprogram}

Sitename: We send news to this site.
\break
article not sent if sitename is in path
\break
{\ltt{}/}don't send any articles from the following list of sites

Patterns: Specifies newsgroups to include (exclude)
\break
{\ltt{}/}distributions can further modify what is included

Flags: 
\break
{\ltt{}<} number -- only small articles send
\break
{\ltt{}F} file name -- spool file
\break
{\ltt{}Nm, Nu}, -- (un)moderated only
\break
{\ltt{}Tlcfp} -- log, channel, file, program

controls file, channel or exploder
\break
{\ltt{}Wb} -- size
\break
{\ltt{}Wf} -- pathname
\break
{\ltt{}Wm} -- include message id
\break
{\ltt{}Wn} -- include token

Parameters: machine or program name

{\ltt{}ME}: special, first, only one such entry,
\break
Pattern: prepend to all other entries
\break
distribution: only those matching are accepted

\newslide
\centerline{\bbf Spools}

The ``spool" is the method by which the articles are stored.
\break
The method chosen is specified in {\ltt{}storage.conf}
\break
Format:

{\cprogram
method <methodname> {
  class: <storage_class>
  newsgroups: <wildmat>
  size: <minsize>[,<maxsize>]
  expires: <mintime>[,<maxtime>]
  options: <options>
}
@endprogram}

The method name

{\ltt{}class}: multiple methods are allowed, each method
mentioned in this file should have a unique class number.
\break
{\ltt{}newsgroups}: a regular expression indicating which
newsgroups use this storage method.
\break
{\ltt{}size}: optional. This method applies only to
articles of the specified size range.
\break
{\ltt{}expires}: This method applies only to
articles of the ``expire" times.
\break
{\ltt{}options}: Special storage handling is used
for this class.

\newslide
\centerline{\bbf Spools (continued)}

Storage methods:
\break
{\ltt{}cnfs}: Cyclic News File System. Articles
are stored in large cyclic buffers.
Wrap-around erases articles.
\break
{\ltt{}timecaf}: Multiple articles per file.
File names based on arrival times.
\break
{\ltt{}timehash}: Single article per file.
File names based on arrival times.
\break
{\ltt{}tradspool}: Single article per file.
File names based on newsgroup.
\break
{\ltt{}trash}: Article are discarded.

We use traditional spooling for all articles.
\vt
{\cprogram
method tradspool {
  class: 1
  newsgroups: *
}
@endprogram}

\newslide
\centerline{\bbf Subscriptions}

This lists the news groups that can be subscribed to by
news readers that are accessing your server.

It is not required.

If a news reader doesn't support the subscriptions options
it is ignored; if a news reader does and doesn't find
anything in the file you get an empty list; (but you
can subscribe anyway, manually).

\newslide
\centerline{\bbf Controlling Innd}

The {\ltt{}ctlinnd} program controls {\ltt{}innd}
\break
by sending messages to its control channel

{\ltt{}ctlinnd [ -h ]}  -- help

{\ltt{}ctlinnd command [argument]} -- issue a command

{\ltt{}flush x.y.csulb.edu} -- flush a buffer for a site.
\break
file: send a batch.
\break
no site--flush all buffers

{\ltt{}begin x.y.csulb.edu} -- start feeding to a site.
\break
newsfeeds is modified
\break
{\ltt{}drop x.y.csulb.edu} -- stop feeding to a site.


{\ltt{}pause bulkedit} -- pause newsfeeds
\break
{\ltt{}go bulkedit} -- unpause newsfeeds
\break
{\ltt{}reload all editedfiles} -- reload all config files

{\ltt{}newgroup local.476} -- start a new group
\break
{\ltt{}rmgroup local.476} -- kill a group
\newslide
\centerline{\bbf Debugging}

{\ltt{}inncheck} -- check the inn configuration
\vt
Raw command: if you are careful and know the look up the parameters
you can (force) run individual commands like {\ltt{}innxmit} or
{\ltt{}nntpsend} and look at the output.
\vt
Old telnet trick: New information--telnet can be used to access any port.

Usage: {\ltt{}telnet lab88.net.cecs.csulb.edu 119}

You should now be talking to the news server.
\break
All commands and responses are in ASCII, you can try them.

\vt
{\ltt{}ctlinnd checkfile} -- have innd check the config files and report
to the screen.
\newslide
\centerline{\bbf trn}

Threaded Read News.
\break
Give somewhat better error messages than tin when debugging a news
setup.

Threads: in a news group several discussions may be occuring.
\break
Goal: follow one line of discussion at a time

Each article: ``Subject" (the thread)

{\ltt{}mthreads}: scan the articles and for each news group build 
a thread database (sort articles by subject)
\break
Can be run by cron: bulk processing
\break
Can be run as a daemon: update the database for each incoming article
\break
Note: We are not using threads.

trn options:

1) reads news from local spool,
\break
innd must be running locally

2) connects to innd on a remote machine to read news, 
\break
innd must be running on the remote and must grant {\ltt{}readers.conf}

\newslide
\centerline{\bbf Basic trn}

{\ltt{}~/.newsrc}: a list of news groups you subscribe to.

{\ltt{}local.xx: 1-77,79,81-90}:
\break
We subscribe to group and have read the listed articles.

{\ltt{}local.476a: 1-0}:
\break
Haven't read anything

{\ltt{}local.yy!}:
\break
We know about this group and didn't subscribe.

By default trn skips news groups with no unread news.

trn Commands: context sensitive.

{\ltt{}read now}, {\ltt{}end of groups}: 
\break
{\ltt{}1}: Go to first newsgroup
\break
{\ltt{}p}: go to previous newsgroup
\break
{\ltt{}A}: abort pretend you never started trn

{\ltt{}g local.xx} -- go to a newsgroup (override)

{\ltt{}read now}:
\break
{\ltt{}U}: enter the newsgroup using Set unread prompt

{\ltt{}what next}: (in a newsgroup
\break
{\ltt{}f}: post a (follow up) article. You will be asked later if it is
a followup or a new subject.

\newslide
Article posting: Subject: {\bit local}, skip others blank
\break
In editor: one blank line after {\ltt{}cc:}, 
\break
no blanks in first line of article

Saving: {\ltt{}~/News/Local.476a} (or specify file name)

\vfill
\centerline{\bbf Newsgroup note}

Several special groups must be included in the List of active news groups
These news groups are:

{\program
control
control.*  (various)
junk
\endprogram}

\bye
